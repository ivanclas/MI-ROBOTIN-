<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHAPI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="friends.png" type="image/png">
  <link rel="manifest" href="manifest.json" /> 
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(45deg, #5c6bc0, #42a5f5);
      margin: 0;
      padding: 0;
      color: white;
      text-align: center;
      overflow-x: hidden;
    }
    h1 {
      font-size: 3.5rem;
      color: white;
      font-weight: 700;
      margin-top: 50px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      animation: fadeIn 1s ease-out;
    }
    h1 i { font-size: 3.5rem; color: #ff4081; transition: transform 0.3s ease-in-out; }
    h1:hover i { transform: rotate(360deg); }
    .container { padding: 30px; width: 90%; max-width: 480px; margin: 0 auto; animation: slideIn 1.2s ease-out; }
    button {
      background-color: #ff4081; color: white; padding: 15px; margin: 20px 0;
      border: none; border-radius: 12px; font-size: 1.4rem; cursor: pointer; width: 100%;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15); transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center;
    }
    button:hover { background-color: #d81b60; transform: translateY(-4px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25); }
    button:active { transform: translateY(0); }
    button i { margin-right: 12px; }
    input, textarea {
      padding: 14px; margin: 12px 0; width: 80%; font-size: 1.1rem;
      border: none; border-radius: 10px; background-color: #fff; color: #333;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;
    }
    input:focus, textarea:focus { border: 2px solid #ff4081; outline: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
    .modal {
      display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6); overflow: auto; padding-top: 60px; transition: opacity 0.3s ease;
      animation: fadeInModal 0.5s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background-color: #fff; margin: 5% auto; padding: 25px; border-radius: 20px;
      width: 80%; max-width: 500px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); animation: zoomIn 0.5s ease-out;
    }
    .close { color: #aaa; font-size: 32px; font-weight: bold; float: right; cursor: pointer; }
    .close:hover { color: #000; }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes zoomIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-robot"></i> ¡Hola! Soy CHAPI</h1>
    <button id="btnAgregar"><i class="fas fa-plus-circle"></i> Agregar pregunta</button>
    <button id="btnConsultar"><i class="fas fa-search"></i> Consultar pregunta</button>
    <button id="btnVoz"><i class="fas fa-microphone"></i> Hablar pregunta</button>
    <p>Agrega tus preguntas y CHAPI las recordará para ti.</p>

    <!-- Modal de Agregar -->
    <div id="modalAgregar" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAgregar">&times;</span>
        <h2>Agregar una nueva pregunta</h2>
        <input type="text" id="inputPregunta" placeholder="Escribe la pregunta">
        <input type="text" id="inputRespuesta" placeholder="Escribe la respuesta">
        <textarea id="inputLote" rows="6" placeholder="Pega varias preguntas y respuestas aquí&#10;Formato: Pregunta|Respuesta"></textarea>
        <button id="guardarBtn">Guardar pregunta</button>
        <button id="guardarLoteBtn">Guardar varias</button>
        <button onclick="ocultarFormulario('modalAgregar')">Cancelar</button>
      </div>
    </div>

    <!-- Modal de Consultar -->
    <div id="modalConsultar" class="modal">
      <div class="modal-content">
        <span class="close" id="closeConsultar">&times;</span>
        <h2>Consultar una pregunta</h2>
        <input type="text" id="consultaPregunta" placeholder="Consulta tu pregunta">
        <button id="consultarBtn">Consultar</button>
        <p id="respuesta"></p>
        <button onclick="ocultarFormulario('modalConsultar')">Cancelar</button>
      </div>
    </div>

    <p id="voiceStatus"></p>
  </div>

  <script type="module" src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8Qixd8Q5DFYu0a5l5jiYC2ODrUbnjwuk",
      authDomain: "guardar-fotos-ec316.firebaseapp.com",
      databaseURL: "https://guardar-fotos-ec316-default-rtdb.firebaseio.com",
      projectId: "guardar-fotos-ec316",
      storageBucket: "guardar-fotos-ec316.appspot.com",
      messagingSenderId: "529201655026",
      appId: "1:529201655026:web:f10e873d825a72b5d8b46b",
      measurementId: "G-SMEHYGBPRR"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const sinonimos = {
      "hora": ["hora","qué hora es","dime la hora"],
      "fecha": ["fecha","qué fecha es","qué día es hoy"]
    };

    function normalizeText(text) {
      return text.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g,"").replace(/\s+/g,"").toLowerCase();
    }

    function expandirConsulta(pregunta) {
      for (const key in sinonimos) {
        if (sinonimos[key].some(s => pregunta.toLowerCase().includes(s))) return key;
      }
      return pregunta;
    }

    function obtenerHoraActual() {
      const ahora = new Date();
      let horas = ahora.getHours();
      const minutos = ahora.getMinutes().toString().padStart(2,'0');
      const segundos = ahora.getSeconds().toString().padStart(2,'0');
      const ampm = horas >= 12 ? 'PM' : 'AM';
      horas = horas % 12 || 12;
      return `La hora actual es: ${horas}:${minutos}:${segundos} ${ampm}`;
    }

    function obtenerFechaActual() {
      const ahora = new Date();
      return `Hoy es: ${ahora.toLocaleDateString('es-ES',{ weekday:'long',year:'numeric',month:'long',day:'numeric'})}`;
    }

    function guardarDatos(pregunta,respuesta) {
      const reference = ref(database,'recordatorios/'+normalizeText(pregunta));
      set(reference,{respuesta}).then(()=>{alert("Guardado.");ocultarFormulario("modalAgregar");});
    }

    function recuperarDatos(pregunta) {
      const reference = ref(database,'recordatorios/');
      const preguntaExp = expandirConsulta(pregunta);
      const normalized = normalizeText(preguntaExp);

      get(reference).then(snapshot=>{
        let found=false;
        if(snapshot.exists()){
          const data=snapshot.val();
          const preguntas=Object.keys(data).map(key=>({pregunta:key,respuesta:data[key].respuesta}));
          const fuse=new Fuse(preguntas,{includeScore:true,threshold:0.4,keys:['pregunta']});
          const results=fuse.search(normalized);
          if(results.length>0){
            const best=results[0].item;
            if(best.pregunta.includes("hora")){ const h=obtenerHoraActual(); document.getElementById("respuesta").textContent=h; hablarRespuesta(h);}
            else if(best.pregunta.includes("fecha")){ const f=obtenerFechaActual(); document.getElementById("respuesta").textContent=f; hablarRespuesta(f);}
            else {document.getElementById("respuesta").textContent="Respuesta: "+best.respuesta; hablarRespuesta(best.respuesta);}
            found=true;
          }
        }
        if(!found){document.getElementById("respuesta").textContent="No se encontró."; hablarRespuesta("Lo siento, no tengo una respuesta.");}
      });
    }

    document.getElementById("btnAgregar").addEventListener("click",()=>mostrarFormulario("modalAgregar"));
    document.getElementById("btnConsultar").addEventListener("click",()=>mostrarFormulario("modalConsultar"));
    function mostrarFormulario(id){document.getElementById("modalAgregar").style.display="none";document.getElementById("modalConsultar").style.display="none";document.getElementById(id).style.display="block";}
    function ocultarFormulario(id){document.getElementById(id).style.display="none";}

    document.getElementById("guardarBtn").addEventListener("click",()=>{
      const p=document.getElementById("inputPregunta").value;
      const r=document.getElementById("inputRespuesta").value;
      guardarDatos(p,r);
    });

    // Guardar varias
    document.getElementById("guardarLoteBtn").addEventListener("click",()=>{
      const texto=document.getElementById("inputLote").value.trim();
      if(!texto){alert("Pega tus preguntas y respuestas.");return;}
      texto.split("\n").forEach(linea=>{
        const partes=linea.split("|");
        if(partes.length===2){guardarDatos(partes[0].trim(),partes[1].trim());}
      });
      alert("Preguntas guardadas.");
      document.getElementById("inputLote").value="";
      ocultarFormulario("modalAgregar");
    });

    document.getElementById("consultarBtn").addEventListener("click",()=>{
      const p=document.getElementById("consultaPregunta").value;
      recuperarDatos(p);
    });

    const recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
    recognition.lang="es-ES";
    recognition.onresult=function(event){
      const q=event.results[0][0].transcript;
      document.getElementById("voiceStatus").textContent=`Pregunta escuchada: ${q}`;
      recuperarDatos(q);
    };
    document.getElementById("btnVoz").addEventListener("click",()=>{
      window.speechSynthesis.cancel(); recognition.stop(); recognition.start();
      document.getElementById("voiceStatus").textContent="Escuchando...";
    });

    function hablarRespuesta(respuesta){
      const speech=new SpeechSynthesisUtterance(respuesta);
      speech.lang="es-ES";
      window.speechSynthesis.speak(speech);
    }

    document.getElementById("closeAgregar").addEventListener("click",()=>ocultarFormulario("modalAgregar"));
    document.getElementById("closeConsultar").addEventListener("click",()=>ocultarFormulario("modalConsultar"));
  </script>
</body>
</html>
